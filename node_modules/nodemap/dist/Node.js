"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _shortid = _interopRequireDefault(require("shortid"));

var _events = require("events");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const del = Symbol.for("delete");

class _Node extends _events.EventEmitter {
  constructor(data = {}) {
    super();
    this._id = data.id || (0, _shortid.default)();
    this._data = data;
    this._parentId = undefined;
    this._childIds = [];
    this._layer = 0;
    this._rootId = undefined;
    this._alive = true;
    this.tree.add(this);
  }

  get id() {
    return this._id;
  }

  get alive() {
    return this._alive;
  }

  get childIds() {
    return [].concat(this._childIds);
  }

  get layer() {
    return this._layer;
  }

  get rootId() {
    return this._rootId;
  }

  get parentId() {
    return this._parentId;
  }

  _aliveValidate() {
    if (!this.alive) {
      throw new Error(`id=${this.id}'s node is dead!`);
    }
  }

  addChild(childNode) {
    this._aliveValidate();

    if (childNode.tree !== this.tree) throw new Error("different tree");
    if (this.childIds.includes(childNode.id)) return this;

    childNode._link(this);

    return this;
  }

  _link(parent) {
    this._aliveValidate();

    this._rootId = parent.rootId;
    this._parentId = parent.id;
    this._layer = parent.layer + 1;
    this._rootId = parent.rootId || parent.id;

    parent._childIds.push(this.id);

    parent._childIds = [...new Set(parent._childIds)];

    this._childIds.forEach(id => this.get(id)._link(this));
  }

  createChild(data) {
    this._aliveValidate();

    const child = new this.constructor(data);
    this.addChild(child);
    return child;
  }

  remove(id) {
    this._aliveValidate();

    if (id) {
      let node = this.get(id);
      if (node) node.remove();
    } else {
      this._allDeepChildIds.forEach(id => {
        let n = this.get(id);
        if (n) n.remove();
      });

      this.tree[del](id);

      if (this.parentId) {
        let parent = this.get(this.parentId);
        let childIdsSet = new Set(parent._childIds);
        childIdsSet.delete(this.id);
        parent._childIds = [...childIdsSet];
      }

      this._layer = 0;
      this._parentId = 0;
      this._rootId = 0;
      this._alive = false; // this._tree = null;
    }
  }

  detach() {
    this._aliveValidate();

    this.moveTo();
  }

  moveTo(parentId) {
    this._aliveValidate();

    if (this.parentId) {
      let parent = this.get(this.parentId);
      let set = new Set(parent._childIds);
      set.delete(this.id);
      parent._childIds = [...set];
    }

    if (parentId) {
      if (this._allDeepChildIds.includes(parentId)) throw new Error("parent node can't move to child's internal");
      var parent = this.get(parentId);

      this._link(parent);
    } else {
      this._parentId = undefined;
      this._rootId = undefined;
      this._layer = 0;

      this._childIds.forEach(id => this.get(id)._link(this));
    }
  }

  get _allDeepChildIds() {
    this._aliveValidate();

    let ids = [].concat(this._childIds);

    this._childIds.forEach(id => ids = ids.concat(this.get(id).allChilds));

    return ids;
  }

  get(id) {
    return this.tree.get(id);
  }

  data(k, v) {
    if (k && typeof k === "string" && !v) {
      return this._data[k];
    } else if (k && typeof k === "object" && !v) {
      this._aliveValidate();

      this._data = _objectSpread({}, this._data, k);
      this.emit("change");
    } else if (k && v) {
      this._aliveValidate();

      this._data[k] = v;
      this.emit("change");
    } else {
      return JSON.parse(JSON.stringify(this._data));
    }
  }

  static parse(json) {
    let {
      id,
      data,
      parentId,
      childIds,
      layer,
      rootId,
      alive
    } = JSON.parse(JSON.stringify(json));
    let n = {
      id,
      data,
      parentId,
      childIds,
      layer,
      rootId,
      alive
    };
    n.__proto__ = this.prototype;
    return n;
  }

  get json() {
    return this.constructor.toJSON(this);
  }

  static toJSON(o) {
    return JSON.parse(JSON.stringify({
      id: o.id,
      data: o._data,
      parentId: o._parentId,
      childIds: o._childIds,
      layer: o._layer,
      rootId: o._rootId,
      alive: o._alive
    }));
  }

  get tree() {
    if (!this._tree) throw new Error("sub class must implements _tree");
    return this._tree;
  }

  static get tree() {
    return this.prototype._tree;
  }

}

exports.default = _Node;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Ob2RlLmpzIl0sIm5hbWVzIjpbImRlbCIsIlN5bWJvbCIsImZvciIsIl9Ob2RlIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJkYXRhIiwiX2lkIiwiaWQiLCJfZGF0YSIsIl9wYXJlbnRJZCIsInVuZGVmaW5lZCIsIl9jaGlsZElkcyIsIl9sYXllciIsIl9yb290SWQiLCJfYWxpdmUiLCJ0cmVlIiwiYWRkIiwiYWxpdmUiLCJjaGlsZElkcyIsImNvbmNhdCIsImxheWVyIiwicm9vdElkIiwicGFyZW50SWQiLCJfYWxpdmVWYWxpZGF0ZSIsIkVycm9yIiwiYWRkQ2hpbGQiLCJjaGlsZE5vZGUiLCJpbmNsdWRlcyIsIl9saW5rIiwicGFyZW50IiwicHVzaCIsIlNldCIsImZvckVhY2giLCJnZXQiLCJjcmVhdGVDaGlsZCIsImNoaWxkIiwicmVtb3ZlIiwibm9kZSIsIl9hbGxEZWVwQ2hpbGRJZHMiLCJuIiwiY2hpbGRJZHNTZXQiLCJkZWxldGUiLCJkZXRhY2giLCJtb3ZlVG8iLCJzZXQiLCJpZHMiLCJhbGxDaGlsZHMiLCJrIiwidiIsImVtaXQiLCJKU09OIiwicGFyc2UiLCJzdHJpbmdpZnkiLCJqc29uIiwiX19wcm90b19fIiwicHJvdG90eXBlIiwidG9KU09OIiwibyIsIl90cmVlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7Ozs7Ozs7O0FBQ0EsTUFBTUEsR0FBRyxHQUFHQyxNQUFNLENBQUNDLEdBQVAsQ0FBVyxRQUFYLENBQVo7O0FBRWUsTUFBTUMsS0FBTixTQUFvQkMsb0JBQXBCLENBQWlDO0FBRTVDQyxFQUFBQSxXQUFXLENBQUNDLElBQUksR0FBRyxFQUFSLEVBQVk7QUFDbkI7QUFDQSxTQUFLQyxHQUFMLEdBQVdELElBQUksQ0FBQ0UsRUFBTCxJQUFXLHVCQUF0QjtBQUNBLFNBQUtDLEtBQUwsR0FBYUgsSUFBYjtBQUNBLFNBQUtJLFNBQUwsR0FBaUJDLFNBQWpCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQixF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QVdELElBQUksQ0FBQ0UsU0FBTCxDQUNkO0FBQ0k3QyxNQUFBQSxFQUFFLEVBQUVrRCxDQUFDLENBQUNsRCxFQURWO0FBRUlGLE1BQUFBLElBQUksRUFBRW9ELENBQUMsQ0FBQ2pELEtBRlo7QUFHSWMsTUFBQUEsUUFBUSxFQUFFbUMsQ0FBQyxDQUFDaEQsU0FIaEI7QUFJSVMsTUFBQUEsUUFBUSxFQUFFdUMsQ0FBQyxDQUFDOUMsU0FKaEI7QUFLSVMsTUFBQUEsS0FBSyxFQUFFcUMsQ0FBQyxDQUFDN0MsTUFMYjtBQU1JUyxNQUFBQSxNQUFNLEVBQUVvQyxDQUFDLENBQUM1QyxPQU5kO0FBT0lJLE1BQUFBLEtBQUssRUFBRXdDLENBQUMsQ0FBQzNDO0FBUGIsS0FEYyxDQUFYLENBQVA7QUFXSDs7QUFFRCxNQUFJQyxJQUFKLEdBQVc7QUFDUCxRQUFJLENBQUMsS0FBSzJDLEtBQVYsRUFDSSxNQUFNLElBQUlsQyxLQUFKLENBQVUsaUNBQVYsQ0FBTjtBQUVKLFdBQU8sS0FBS2tDLEtBQVo7QUFDSDs7QUFFRCxhQUFXM0MsSUFBWCxHQUFrQjtBQUNkLFdBQU8sS0FBS3dDLFNBQUwsQ0FBZUcsS0FBdEI7QUFDSDs7QUE3TTJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHVpZCBmcm9tIFwic2hvcnRpZFwiO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50c1wiO1xuY29uc3QgZGVsID0gU3ltYm9sLmZvcihcImRlbGV0ZVwiKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgX05vZGUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuXG4gICAgY29uc3RydWN0b3IoZGF0YSA9IHt9KSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX2lkID0gZGF0YS5pZCB8fCB1aWQoKTtcbiAgICAgICAgdGhpcy5fZGF0YSA9IGRhdGE7XG4gICAgICAgIHRoaXMuX3BhcmVudElkID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLl9jaGlsZElkcyA9IFtdO1xuICAgICAgICB0aGlzLl9sYXllciA9IDA7XG4gICAgICAgIHRoaXMuX3Jvb3RJZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5fYWxpdmUgPSB0cnVlO1xuICAgICAgICB0aGlzLnRyZWUuYWRkKHRoaXMpO1xuICAgIH1cblxuICAgIGdldCBpZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lkO1xuICAgIH1cblxuICAgIGdldCBhbGl2ZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FsaXZlO1xuICAgIH1cblxuICAgIGdldCBjaGlsZElkcygpIHtcbiAgICAgICAgcmV0dXJuIFtdLmNvbmNhdCh0aGlzLl9jaGlsZElkcyk7XG4gICAgfVxuXG4gICAgZ2V0IGxheWVyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fbGF5ZXI7XG4gICAgfVxuXG4gICAgZ2V0IHJvb3RJZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Jvb3RJZDtcbiAgICB9XG5cbiAgICBnZXQgcGFyZW50SWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9wYXJlbnRJZDtcbiAgICB9XG5cbiAgICBfYWxpdmVWYWxpZGF0ZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmFsaXZlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGlkPSR7dGhpcy5pZH0ncyBub2RlIGlzIGRlYWQhYCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRDaGlsZChjaGlsZE5vZGUpIHtcbiAgICAgICAgdGhpcy5fYWxpdmVWYWxpZGF0ZSgpO1xuICAgICAgICBpZiAoY2hpbGROb2RlLnRyZWUgIT09IHRoaXMudHJlZSkgdGhyb3cgbmV3IEVycm9yKFwiZGlmZmVyZW50IHRyZWVcIik7XG4gICAgICAgIGlmICh0aGlzLmNoaWxkSWRzLmluY2x1ZGVzKGNoaWxkTm9kZS5pZCkpIHJldHVybiB0aGlzO1xuICAgICAgICBjaGlsZE5vZGUuX2xpbmsodGhpcyk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIF9saW5rKHBhcmVudCkge1xuICAgICAgICB0aGlzLl9hbGl2ZVZhbGlkYXRlKCk7XG4gICAgICAgIHRoaXMuX3Jvb3RJZCA9IHBhcmVudC5yb290SWQ7XG4gICAgICAgIHRoaXMuX3BhcmVudElkID0gcGFyZW50LmlkO1xuICAgICAgICB0aGlzLl9sYXllciA9IHBhcmVudC5sYXllciArIDE7XG4gICAgICAgIHRoaXMuX3Jvb3RJZCA9IHBhcmVudC5yb290SWQgfHwgcGFyZW50LmlkO1xuICAgICAgICBwYXJlbnQuX2NoaWxkSWRzLnB1c2godGhpcy5pZCk7XG4gICAgICAgIHBhcmVudC5fY2hpbGRJZHMgPSBbLi4ubmV3IFNldChwYXJlbnQuX2NoaWxkSWRzKV07XG4gICAgICAgIHRoaXMuX2NoaWxkSWRzLmZvckVhY2goaWQgPT4gdGhpcy5nZXQoaWQpLl9saW5rKHRoaXMpKTtcbiAgICB9XG5cbiAgICBjcmVhdGVDaGlsZChkYXRhKSB7XG4gICAgICAgIHRoaXMuX2FsaXZlVmFsaWRhdGUoKTtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBuZXcgdGhpcy5jb25zdHJ1Y3RvcihkYXRhKTtcbiAgICAgICAgdGhpcy5hZGRDaGlsZChjaGlsZCk7XG4gICAgICAgIHJldHVybiBjaGlsZDtcbiAgICB9XG5cbiAgICByZW1vdmUoaWQpIHtcbiAgICAgICAgdGhpcy5fYWxpdmVWYWxpZGF0ZSgpO1xuICAgICAgICBpZiAoaWQpIHtcbiAgICAgICAgICAgIGxldCBub2RlID0gdGhpcy5nZXQoaWQpO1xuICAgICAgICAgICAgaWYgKG5vZGUpXG4gICAgICAgICAgICAgICAgbm9kZS5yZW1vdmUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2FsbERlZXBDaGlsZElkcy5mb3JFYWNoKGlkID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbiA9IHRoaXMuZ2V0KGlkKVxuICAgICAgICAgICAgICAgIGlmIChuKVxuICAgICAgICAgICAgICAgICAgICBuLnJlbW92ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnRyZWVbZGVsXShpZCk7XG4gICAgICAgICAgICBpZiAodGhpcy5wYXJlbnRJZCkge1xuICAgICAgICAgICAgICAgIGxldCBwYXJlbnQgPSB0aGlzLmdldCh0aGlzLnBhcmVudElkKTtcbiAgICAgICAgICAgICAgICBsZXQgY2hpbGRJZHNTZXQgPSBuZXcgU2V0KHBhcmVudC5fY2hpbGRJZHMpO1xuICAgICAgICAgICAgICAgIGNoaWxkSWRzU2V0LmRlbGV0ZSh0aGlzLmlkKTtcbiAgICAgICAgICAgICAgICBwYXJlbnQuX2NoaWxkSWRzID0gWy4uLmNoaWxkSWRzU2V0XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2xheWVyID0gMDtcbiAgICAgICAgICAgIHRoaXMuX3BhcmVudElkID0gMDtcbiAgICAgICAgICAgIHRoaXMuX3Jvb3RJZCA9IDA7XG4gICAgICAgICAgICB0aGlzLl9hbGl2ZSA9IGZhbHNlO1xuICAgICAgICAgICAgLy8gdGhpcy5fdHJlZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZXRhY2goKSB7XG4gICAgICAgIHRoaXMuX2FsaXZlVmFsaWRhdGUoKTtcbiAgICAgICAgdGhpcy5tb3ZlVG8oKTtcbiAgICB9XG5cbiAgICBtb3ZlVG8ocGFyZW50SWQpIHtcblxuICAgICAgICB0aGlzLl9hbGl2ZVZhbGlkYXRlKCk7XG5cbiAgICAgICAgaWYgKHRoaXMucGFyZW50SWQpIHtcbiAgICAgICAgICAgIGxldCBwYXJlbnQgPSB0aGlzLmdldCh0aGlzLnBhcmVudElkKTtcbiAgICAgICAgICAgIGxldCBzZXQgPSBuZXcgU2V0KHBhcmVudC5fY2hpbGRJZHMpO1xuICAgICAgICAgICAgc2V0LmRlbGV0ZSh0aGlzLmlkKTtcbiAgICAgICAgICAgIHBhcmVudC5fY2hpbGRJZHMgPSBbLi4uc2V0XTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYXJlbnRJZCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2FsbERlZXBDaGlsZElkcy5pbmNsdWRlcyhwYXJlbnRJZCkpIHRocm93IG5ldyBFcnJvcihcInBhcmVudCBub2RlIGNhbid0IG1vdmUgdG8gY2hpbGQncyBpbnRlcm5hbFwiKVxuICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuZ2V0KHBhcmVudElkKTtcbiAgICAgICAgICAgIHRoaXMuX2xpbmsocGFyZW50KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3BhcmVudElkID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy5fcm9vdElkID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy5fbGF5ZXIgPSAwO1xuICAgICAgICAgICAgdGhpcy5fY2hpbGRJZHMuZm9yRWFjaChpZCA9PiB0aGlzLmdldChpZCkuX2xpbmsodGhpcykpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBnZXQgX2FsbERlZXBDaGlsZElkcygpIHtcbiAgICAgICAgdGhpcy5fYWxpdmVWYWxpZGF0ZSgpO1xuICAgICAgICBsZXQgaWRzID0gW10uY29uY2F0KHRoaXMuX2NoaWxkSWRzKTtcbiAgICAgICAgdGhpcy5fY2hpbGRJZHMuZm9yRWFjaChpZCA9PiBpZHMgPSBpZHMuY29uY2F0KHRoaXMuZ2V0KGlkKS5hbGxDaGlsZHMpKVxuICAgICAgICByZXR1cm4gaWRzO1xuICAgIH1cblxuICAgIGdldChpZCkge1xuICAgICAgICByZXR1cm4gdGhpcy50cmVlLmdldChpZCk7XG4gICAgfVxuXG4gICAgZGF0YShrLCB2KSB7XG4gICAgICAgIGlmIChrICYmIHR5cGVvZiBrID09PSBcInN0cmluZ1wiICYmICF2KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZGF0YVtrXTtcbiAgICAgICAgfSBlbHNlIGlmIChrICYmIHR5cGVvZiBrID09PSBcIm9iamVjdFwiICYmICF2KSB7XG4gICAgICAgICAgICB0aGlzLl9hbGl2ZVZhbGlkYXRlKCk7XG4gICAgICAgICAgICB0aGlzLl9kYXRhID0geyAuLi50aGlzLl9kYXRhLCAuLi5rIH07XG4gICAgICAgICAgICB0aGlzLmVtaXQoXCJjaGFuZ2VcIik7XG4gICAgICAgIH0gZWxzZSBpZiAoayAmJiB2KSB7XG4gICAgICAgICAgICB0aGlzLl9hbGl2ZVZhbGlkYXRlKCk7XG4gICAgICAgICAgICB0aGlzLl9kYXRhW2tdID0gdjtcbiAgICAgICAgICAgIHRoaXMuZW1pdChcImNoYW5nZVwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuX2RhdGEpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBwYXJzZShqc29uKSB7XG4gICAgICAgIGxldCB7XG4gICAgICAgICAgICBpZCxcbiAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICBwYXJlbnRJZCxcbiAgICAgICAgICAgIGNoaWxkSWRzLFxuICAgICAgICAgICAgbGF5ZXIsXG4gICAgICAgICAgICByb290SWQsXG4gICAgICAgICAgICBhbGl2ZSxcbiAgICAgICAgfSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoanNvbikpO1xuXG4gICAgICAgIGxldCBuID0ge1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgcGFyZW50SWQsXG4gICAgICAgICAgICBjaGlsZElkcyxcbiAgICAgICAgICAgIGxheWVyLFxuICAgICAgICAgICAgcm9vdElkLFxuICAgICAgICAgICAgYWxpdmUsXG4gICAgICAgIH1cblxuICAgICAgICBuLl9fcHJvdG9fXyA9IHRoaXMucHJvdG90eXBlO1xuICAgICAgICByZXR1cm4gbjtcbiAgICB9XG5cbiAgICBnZXQganNvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudG9KU09OKHRoaXMpO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b0pTT04obykge1xuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZDogby5pZCxcbiAgICAgICAgICAgICAgICBkYXRhOiBvLl9kYXRhLFxuICAgICAgICAgICAgICAgIHBhcmVudElkOiBvLl9wYXJlbnRJZCxcbiAgICAgICAgICAgICAgICBjaGlsZElkczogby5fY2hpbGRJZHMsXG4gICAgICAgICAgICAgICAgbGF5ZXI6IG8uX2xheWVyLFxuICAgICAgICAgICAgICAgIHJvb3RJZDogby5fcm9vdElkLFxuICAgICAgICAgICAgICAgIGFsaXZlOiBvLl9hbGl2ZVxuICAgICAgICAgICAgfVxuICAgICAgICApKTtcbiAgICB9XG5cbiAgICBnZXQgdHJlZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl90cmVlKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwic3ViIGNsYXNzIG11c3QgaW1wbGVtZW50cyBfdHJlZVwiKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fdHJlZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0IHRyZWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3RvdHlwZS5fdHJlZTtcbiAgICB9XG5cbn1cbiJdfQ==